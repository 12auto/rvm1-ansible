---

- name: Detect if rubies are installed
  command: '{{ rvm1 }} {{ item }} do true'
  changed_when: False
  failed_when: False
  register: detect_rubies
  with_items: rvm1_rubies
  when: rvm1_rubies

- name: Install rubies
  command: '{{ rvm1 }} install {{ item.item }}'
  when: rvm1_rubies and item.rc != 0
  with_items: detect_rubies.results

- name: Detect default ruby version
  command: '{{ rvm1 }} alias list default'
  changed_when: False
  register: detect_default_ruby_version

- name: Select default ruby
  command: '{{ rvm1 }} alias create default {{ rvm1_default_ruby_version }}'
  when: detect_default_ruby_version.stdout == '' or
        rvm1_default_ruby_version not in detect_default_ruby_version.stdout

- name: Set rvm install path permissions
  file:
    path: '{{ rvm1_install_path }}'
    state: 'directory'
    recurse: True
    owner: '{{ rvm1_user }}'
    group: '{{ rvm1_group }}'

- name: Detect if ruby version can be deleted
  command: '{{ rvm1 }} {{ rvm1_delete_ruby }} do true'
  changed_when: False
  failed_when: False
  register: detect_delete_ruby
  when: rvm1_delete_ruby

- name: Delete ruby version
  command: '{{ rvm1 }} remove {{ rvm1_delete_ruby }}'
  changed_when: False
  when: rvm1_delete_ruby and detect_delete_ruby.rc == 0
